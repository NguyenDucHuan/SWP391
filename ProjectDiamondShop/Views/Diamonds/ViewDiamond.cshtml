@model DiamondShopBOs.tblDiamond
@{
    ViewBag.Title = "Diamond Details";
    Layout = "~/Views/Shared/_LayoutPage1.cshtml";
}
<link href="~/Content/ProductCss/linearicons.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link href="~/Content/Diamonds/ViewDiamond.css" rel="stylesheet" />

<div class="container container-custom">
    <a href="@Url.Action("Index", "Diamonds")" class="back-to-gallery">
        <span class="lnr lnr-exit"></span>Back to Gallery
    </a>
    <div class="row row-custom">
        <div class="col-md-6">
            <div id="mainImageContainer" class="main-image-container">
                <img id="mainImage" src="@Model.diamondImagePath.Split('|')[0]" alt="@Model.diamondName" class="img-responsive">
            </div>
            <div class="thumbnail-container">
                @foreach (var imagePath in Model.diamondImagePath.Split('|').Select((value, index) => new { value, index }))
                {
                    <button class="thumbnail-button" data-image="@imagePath.value">
                        <img src="@imagePath.value" alt="@Model.diamondName @imagePath.index" class="img-thumbnail">
                    </button>
                }
                @if (ViewBag.Certificates != null && ViewBag.Certificates.Count > 0)
                {
                    foreach (var certificate in ViewBag.Certificates)
                    {
                        <button class="thumbnail-button-cert" data-image="@Url.Content(certificate.cerImagePath)">
                            <img src="@Url.Content(certificate.cerImagePath)" alt="@certificate.certificateNumber" class="img-thumbnail">
                        </button>
                    }
                }
            </div>
        </div>
        <div class="col-md-6">
            <h2 class="diamond-title">@Model.diamondName</h2>
            <p>@Model.diamondDescription</p>
            <p><strong>Price:</strong> $@String.Format("{0:N0}", @Model.diamondPrice)</p>
            <div class="action-buttons">
                @using (Html.BeginForm("AddToCart", "Cart", FormMethod.Post, new { id = "add-to-cart-form" }))
                {
                    @Html.Hidden("diamondID", Model.diamondID)
                    @Html.Hidden("accentStoneID", "0", new { id = "accentStoneID" })
                    @Html.Hidden("settingID", "0", new { id = "settingID" })
                    @Html.Hidden("settingSize", "0", new { id = "settingSize" })
                    <button type="button" id="add-to-cart-button" class="btn-custom">
                        <span class="lnr"></span>Add to Cart
                    </button>
                }
            </div>
        </div>
    </div>
    <div class="row additional-info">
        <div class="col-md-12">
            <h3>Additional Information</h3>
            <table class="table table-bordered table-custom">
                <tr>
                    <td>Color Grade</td>
                    <td>@Model.colorID</td>
                </tr>
                <tr>
                    <td>Clarity Grade</td>
                    <td>@Model.clarityID</td>
                </tr>
                <tr>
                    <td>Color</td>
                    <td>@Model.colorID</td>
                </tr>
                <tr>
                    <td>Cut</td>
                    <td>@Model.cutID</td>
                </tr>
                <tr>
                    <td>Shape</td>
                    <td>@Model.shapeID</td>
                </tr>
                <tr>
                    <td>Carat Weight</td>
                    <td>@Model.caratWeight</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row row-custom">
        <div class="col-md-6 quality-commitment">
            <h3>Quality Commitment</h3>
            <ul>
                <li>All jewelry is precisely accurate in gold content and weight, verified by spectrophotometry.</li>
                <li>100% of diamond jewelry has GIA certification.</li>
                <li>All products at Diamond Shop come with full invoices and documents proving origin and complete information on gold content and weight.</li>
            </ul>
        </div>
        <div class="col-md-6 purchase-instructions">
            <h3>Purchase Instructions</h3>
            <ul>
                <li>Method 1: Please contact the hotline at 0349.446.608 to directly speak with a customer care expert for consultation and purchase.</li>
                <li>Method 2: Please click on the "Contact Us" button, choose the nearest Diamond Shop store to directly select and purchase products.</li>
            </ul>
        </div>
    </div>
</div>

<!-- Modal for selecting accentStone and setting -->
<div id="selectionModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Accent Stone and Setting</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="setting">Setting</label>
                    <select id="setting" class="form-control select2">
                        <option value="0" data-image="/path/to/default-image.jpg">No setting</option>
                    </select>
                </div>
                <div class="form-group" id="settingSizeGroup" style="display:none;">
                    <label for="settingSize">Setting Size</label>
                    <input type="number" id="settingSizeInput" class="form-control" placeholder="Enter setting size" required>
                </div>
                <div class="form-group">
                    <label for="accentStone">Accent Stone</label>
                    <select id="accentStone" class="form-control select2" disabled>
                        <option value="0" data-image="/path/to/default-image.jpg">No accent stone</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirm-selection" class="btn btn-primary">Confirm</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for displaying enlarged certification image -->
<div id="certificationModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <img id="certificationImage" src="" class="img-responsive" style="width: 100%;">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.select2').select2({
                templateResult: formatState,
                templateSelection: formatState,
                dropdownParent: $('#selectionModal')
            });

            function formatState(state) {
                if (!state.id) {
                    return state.text;
                }
                var $state = $(
                    '<span><img src="' + state.element.getAttribute('data-image') + '" class="img-flag" style="width: 20px; height: 20px; margin-right: 10px;" /> ' + state.text + '</span>'
                );
                return $state;
            }

            $(".thumbnail-button").click(function () {
                var newImage = $(this).data('image');
                $("#mainImage").attr('src', newImage);
            });

            $(".thumbnail-button-cert").click(function () {
                var certImage = $(this).data('image');
                $("#certificationImage").attr('src', certImage);
                $('#certificationModal').modal('show');
            });

            $("#add-to-cart-button").click(function () {
                loadSettings();
                loadAccentStones();
                $('#selectionModal').modal('show');
            });

            function loadSettings() {
                $.ajax({
                    url: '@Url.Action("GetSettings", "Diamonds")',
                    type: 'GET',
                    success: function (data) {
                        var settingsSelect = $("#setting");
                        settingsSelect.empty();
                        settingsSelect.append('<option value="0" data-image="/path/to/default-image.jpg">No setting</option>');
                        $.each(data, function (i, setting) {
                            settingsSelect.append('<option value="' + setting.settingID + '" data-image="' + setting.imagePath + '">' + setting.settingType + ' - ' + setting.material + '</option>');
                        });

                        settingsSelect.on('change', function () {
                            if ($(this).val() != "0") {
                                $('#accentStone').prop('disabled', false);
                                $('#settingSizeGroup').show(); // Show setting size input
                            } else {
                                $('#accentStone').prop('disabled', true);
                                $('#settingSizeGroup').hide(); // Hide setting size input
                                $('#settingSizeInput').val(''); // Clear setting size input
                                $('#accentStone').val("0").trigger('change');
                            }
                        });
                    }
                });
            }

            function loadAccentStones() {
                $.ajax({
                    url: '@Url.Action("GetAccentStones", "Diamonds")',
                    type: 'GET',
                    success: function (data) {
                        var accentStoneSelect = $("#accentStone");
                        accentStoneSelect.empty();
                        accentStoneSelect.append('<option value="0" data-image="/path/to/default-image.jpg">No accent stone</option>');
                        $.each(data, function (i, accentStone) {
                            accentStoneSelect.append('<option value="' + accentStone.accentStoneID + '" data-image="' + accentStone.imagePath + '">' + accentStone.shape + ' - ' + accentStone.caratWeight + 'ct</option>');
                        });
                    }
                });
            }

            $("#confirm-selection").click(function () {
                var selectedAccentStoneId = $("#accentStone").val();
                var selectedSettingId = $("#setting").val();
                var settingSize = $("#settingSizeInput").val();

                if (selectedSettingId != "0" && settingSize.trim() === "") {
                    alert("Please enter the setting size.");
                    return;
                }

                $("#accentStoneID").val(selectedAccentStoneId);
                $("#settingID").val(selectedSettingId);
                $("#settingSize").val(settingSize);

                $('#selectionModal').modal('hide');
                $("#add-to-cart-form").submit();
            });

            // Handle modal close button click
            $(".close, .btn-secondary").click(function() {
                $('#selectionModal').modal('hide');
            });
        });
    </script>
}
