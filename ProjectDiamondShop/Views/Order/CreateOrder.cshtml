@model DiamondShopDAOs.CookieCartDAO.CartDao

@{
    ViewBag.Title = "Create Order";
    Layout = "~/Views/Shared/_LayoutPage1.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    h2 {
        margin-top: 50px;
        text-align: center;
    }

    .container {
        max-width: 800px;
        padding: 20px;
        background-color: #ffffff;
        margin-top: 100px;
        margin-bottom: 60px;
    }

    .table {
        width: 100%;
        margin-bottom: 20px;
        border-collapse: collapse;
    }

        .table th, .table td {
            padding: 10px;
            border: none;
        }

    .form-group {
        margin-bottom: 15px;
    }

    .btn-primary, .btn-voucher {
        font-size: 16px;
        padding: 10px 20px;
        border-radius: 50px;
        margin: 5px;
        flex: 1;
        color: #fff;
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    .btn-primary {
        background-color: #28a745;
        border-color: #28a745;
    }

    .btn-voucher {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }

        .btn-primary:hover, .btn-voucher:hover {
            background-color: #218838;
            border-color: #1e7e34;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-voucher:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        .btn-primary:focus, .btn-voucher:focus {
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.5);
        }

    .alert-info {
        color: #004085;
        background-color: #cce5ff;
        border-color: #b8daff;
        text-align: center;
    }

        .alert-info strong {
            font-weight: bold;
        }

    .no-border-table td {
        border: none !important;
    }

    .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    /*   .footer {
        text-align: center;
        padding: 20px 0;
        color: #333;
    }

        .footer a {
            color: #00509e;
            text-decoration: none;
            margin: 0 10px;
        }

            .footer a:hover {
                color: #003f7d;
                text-decoration: underline;
            }*/
</style>

<h2><i class="fas fa-shopping-cart"></i> Create Order</h2>

<div class="container">
    <div id="noteSection" style="display: none;" class="alert alert-info" role="alert">
        <strong>Please note:</strong> You will need to pay a 20% deposit before placing your order. Deposit amount: <span id="depositAmount"></span>
    </div>

    <table class="table table-bordered no-border-table">
        <tbody>
            @foreach (var item in Model.Items)
            {
                if (item.settingID == null)
                {
                    string[] imagepart = item.imagePath.Split('|');
                    <tr>
                        <td>
                            <strong>Diamond Name:</strong> @item.DiamondName <br />
                            <img src="@imagepart[1]" alt="Diamond Image" style="max-height:50px;" />
                        </td>
                        <td>
                            <strong>Total Price:</strong> $@item.diamondPrice
                        </td>
                    </tr>
                }
                else
                {
                    string[] imagepart = item.imagePath.Split('|');
                    <tr>
                        <td>
                            <strong>Diamond Name:</strong> @item.DiamondName <br />
                            <img src="@imagepart[0]" alt="Diamond Image" style="max-height:50px;" />
                        </td>
                        <td>
                            <strong>Setting Name:</strong> @item.decription <br />
                            <strong>Setting Price:</strong> $@item.settingPrice
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <strong>Accent Stone:</strong> @item.accentStoneID <br />
                            <strong>Accent Stone Price:</strong> $@item.accentStonePrice <br />
                            <strong>Accent Stone Quantity:</strong> @item.quantityAccent
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <strong>Diamond Price:</strong> $@item.diamondPrice <br />
                            <img src="@imagepart[1]" alt="Diamond Image" style="max-height:50px;" />
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <div class="form-group">
        <label for="VoucherID">Voucher:</label>
        <select id="VoucherID" name="voucherID" class="form-control">
            <option value="">Select Voucher</option>
            @foreach (var voucher in ViewBag.Vouchers as List<DiamondShopBOs.tblVoucher>)
            {
                <option value="@voucher.voucherID" data-discount="@voucher.discount">@voucher.voucherID - @voucher.discount %</option>
            }
        </select>
    </div>
    <div class="form-group" id="discountSection" style="display:none;">
        <p>You will get a discount of: $<span id="DiscountAmount"></span></p>
        <p>Total after discount: $<span id="DiscountedTotal"></span></p>
    </div>

    <div class="form-group">
        <label for="CustomerName">Customer Name:</label>
        <input type="text" id="CustomerName" name="customerName" class="form-control" placeholder="Enter Customer Name" required />
        <div id="customerNameError" style="color: red; display: none;">Please enter customer name.</div>
    </div>

    <div class="form-group">
        <label for="Address">Address:</label>
        <input type="text" id="Address" name="address" class="form-control" placeholder="Enter Address" required />
        <div id="addressError" style="color: red; display: none;">Please enter your address.</div>
    </div>
    <div class="form-group">
        <label for="Phone">Phone:</label>
        <input type="text" id="Phone" name="phone" class="form-control" placeholder="Enter Phone" required />
        <div id="phoneError" style="color: red; display: none;">Please enter your phone number.</div>
    </div>
    <div class="form-group">
        <label for="Total">Total:</label>
        <input type="text" class="form-control" id="Total" value="$@Model.Items.Sum(i => (i.diamondPrice + i.settingPrice + (i.accentStonePrice * i.quantityAccent)))" disabled />
    </div>

    <div class="button-group">
        <button type="button" class="btn btn-voucher" onclick="applyVoucher()">Add Voucher</button>
        <button type="submit" class="btn btn-primary" onclick="return validateForm()">Create Order</button>
    </div>

    <form id="paymentForm" action="/order/PaymentWithPayPal" method="post" style="display:none;">
        <input type="hidden" id="hiddenCustomerName" name="customerName" />
        <input type="hidden" id="hiddenAddress" name="address" />
        <input type="hidden" id="hiddenPhone" name="phone" />
        <input type="hidden" id="hiddenVoucherID" name="voucherID" />
    </form>
</div>



<script>
    function applyVoucher() {
        var voucherSelect = document.getElementById("VoucherID");
        var selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
        var discount = parseFloat(selectedOption.getAttribute("data-discount")) || 0;
        var totalPrice = parseFloat(document.getElementById("Total").value.replace("$", ""));

        var discountAmount = totalPrice * (discount / 100);
        var discountedTotal = totalPrice - discountAmount;

        document.getElementById("DiscountAmount").innerText = discountAmount.toFixed(2);
        document.getElementById("DiscountedTotal").innerText = discountedTotal.toFixed(2);

        document.getElementById("Total").value = "$" + discountedTotal.toFixed(2); // Update the Total field

        document.getElementById("discountSection").style.display = "block";
    }

    function validateForm() {
        var customerName = document.getElementById("CustomerName").value;
        var address = document.getElementById("Address").value;
        var phone = document.getElementById("Phone").value;
        var voucherID = document.getElementById("VoucherID").value;

        // Kiểm tra xem customerName, address và phone có được điền đầy đủ hay không
        if (customerName.trim() === "") {
            document.getElementById("customerNameError").style.display = "block";
            return false;
        } else {
            document.getElementById("customerNameError").style.display = "none";
        }
        if (address.trim() === "") {
            document.getElementById("addressError").style.display = "block";
            return false;
        } else {
            document.getElementById("addressError").style.display = "none";
        }

        if (phone.trim() === "") {
            document.getElementById("phoneError").style.display = "block";
            return false;
        } else {
            document.getElementById("phoneError").style.display = "none";
        }

        var totalPrice = parseFloat(document.getElementById("Total").value.replace("$", ""));
        var depositAmount = totalPrice * 0.2; // Tính toán số tiền cần đặt cọc (20%)
        document.getElementById("depositAmount").innerText = "$" + depositAmount.toFixed(2);

        // Hiển thị phần note khi nhấp vào nút "Create Order"
        document.getElementById("noteSection").style.display = "block";

        // Set hidden form fields
        document.getElementById("hiddenCustomerName").value = customerName;
        document.getElementById("hiddenAddress").value = address;
        document.getElementById("hiddenPhone").value = phone;
        document.getElementById("hiddenVoucherID").value = voucherID;


        // Submit the hidden form
        document.getElementById("paymentForm").submit();
        return false;
    }
</script>
